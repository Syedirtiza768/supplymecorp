# Nginx Configuration for HTTP/2
# Add these settings to your existing Nginx server block
# 
# Location: /etc/nginx/sites-available/supplymecorp
#
# NOTE: HTTP/2 Server Push is DISABLED due to protocol errors with large WebP files
# HTTP/2 is still enabled for performance, just not the push feature

# Add inside server block:

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;
    
    # HTTP/2 Server Push DISABLED - causes ERR_HTTP2_PROTOCOL_ERROR
    # http2_push_preload on;
    
    # Root location
    root /var/www/supplymecorp;
    index index.html;

    # ============================================
    # HTTP/2 SERVER PUSH DISABLED
    # ============================================
    # Server Push causes ERR_HTTP2_PROTOCOL_ERROR with large WebP files
    # Using standard HTTP/2 without push for better compatibility
    
    # Homepage
    location = / {
        try_files $uri $uri/ /index.html;
    }
    
    # Flipbook pages
    location ~ ^/flipbook {
        try_files $uri $uri/ /index.html;
    }

    # ============================================
    # STATIC ASSETS - AGGRESSIVE CACHING
    # ============================================
    
    # Flipbook images - 1 year cache
    location /uploads/flipbooks/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Aggressive caching for images
        expires 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Vary "Accept-Encoding";
        
        # Enable gzip for WebP (usually minimal compression)
        gzip off;
    }
    
    # Service Worker - no cache
    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Service-Worker-Allowed "/";
        try_files $uri =404;
    }

    # ============================================
    # API PROXY
    # ============================================
    
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Enable response caching at Nginx level
        proxy_cache_valid 200 5m;
        add_header X-Cache-Status $upstream_cache_status;
        
        # Compression for JSON
        gzip on;
        gzip_types application/json;
    }

    # ============================================
    # NEXT.JS FRONTEND
    # ============================================
    
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

# ============================================
# ALTERNATIVE: Link Header Method
# ============================================
# 
# If http2_push is not available, use Link headers instead.
# Modern browsers will preload resources specified in Link headers.
#
# Add to location blocks:
#
#     add_header Link '</uploads/flipbooks/2025-26-Fall-Winter-Catalogue/page-0.webp>; rel=preload; as=image; type=image/webp, </uploads/flipbooks/2025-26-Fall-Winter-Catalogue/page-1.webp>; rel=preload; as=image; type=image/webp';
#
# This works with HTTP/1.1 and HTTP/2.

# ============================================
# TESTING HTTP/2 PUSH
# ============================================
#
# To verify HTTP/2 Push is working:
#
# 1. Chrome DevTools:
#    - Open Network tab
#    - Look for "Push" in "Initiator" column
#    - Resources pushed will show immediately after HTML
#
# 2. Command line:
#    nghttp -nv https://yourdomain.com/
#    (Look for PUSH_PROMISE frames)
#
# 3. curl with HTTP/2:
#    curl -I --http2 https://yourdomain.com/
#    (Check for Link headers)
